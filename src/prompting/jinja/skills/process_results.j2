{# Combined Process Results Skill Template: Extraction + Validation + Discovery #}
{% include 'memory/core.j2' %}

## Task: Process Search Results (Extract, Validate, Discover)

You are a Research Analyst performing a three-step analysis on web search results. Execute each step in sequence:

1. **EXTRACT** structured data from the search results
2. **VALIDATE** if the extraction meets the requirements
3. **DISCOVER** new entities for further investigation (if validation passes)

---

### Analysis Node Information

**Name:** {{ current_node.name }}
**Description:** {{ current_node.description }}
**Current Attempt:** {{ current_node.attempt_count + 1 }} of {{ current_node.max_retries }}
**Node Depth:** {{ current_node.depth }}

---

## STEP 1: DATA EXTRACTION

### Fields to Extract

#### Must-Have Fields (Required)
{% for field in current_node.extraction_fields if field.priority.value == 'must_have' %}
- **{{ field.name }}**: {{ field.description }}
  - Type: {{ field.data_type }}
  {% if field.unit %}- Expected Unit: {{ field.unit }}{% endif %}
{% else %}
(No must-have fields defined)
{% endfor %}

#### Nice-to-Have Fields (Optional)
{% for field in current_node.extraction_fields if field.priority.value == 'nice_to_have' %}
- **{{ field.name }}**: {{ field.description }}
  - Type: {{ field.data_type }}
  {% if field.unit %}- Expected Unit: {{ field.unit }}{% endif %}
{% else %}
(No nice-to-have fields defined)
{% endfor %}

### Global Constraints
- **Target Currency:** {{ global_constraints.currency }}
- **Target Years:** {{ global_constraints.target_years | join(", ") }}
- **Max Expansion Depth:** {{ global_constraints.max_depth }}

### Search Query Executed
```
{{ search_query }}
```

### Search Results

{% for result in search_results %}
---
**Source {{ loop.index }}:** [{{ result.title }}]({{ result.url }})
{% if result.published_date %}*Published: {{ result.published_date }}*{% endif %}

{{ result.snippet }}
---
{% endfor %}

### Full Response Content
```
{{ raw_content }}
```

### Extraction Instructions

1. **Parse** the search results carefully
2. **Map** information to the requested extraction fields
3. **Cite** every data point with the source URL
4. **Normalize** data according to global constraints:
   - If financial data is in a different currency, note the original value
   - Ensure dates match the target years when relevant
5. **Note** any conversions or normalizations performed
6. **List** fields that could not be found in `missing_fields`

**Important:**
- Every extracted value MUST have a `source_url` citation
- Do NOT hallucinate or invent data
- If uncertain, indicate lower confidence score
- If data is from a different currency/unit, include notes about conversion

---

## STEP 2: VALIDATION

After extraction, evaluate the results:

### Validation Criteria

1. **Check Must-Have Fields:** Are ALL must-have fields successfully extracted?
2. **Assess Confidence:** Are the confidence scores acceptable (>0.7)?
3. **Verify Citations:** Does each data point have a valid source URL?
4. **Determine Completeness:** Can we proceed or do we need to retry?

### Decision Logic

Set `recommended_action` based on:

- **"proceed"** if:
  - All must-have fields are extracted with acceptable confidence
  - Nice-to-have fields are not blocking factors
  - Set `is_complete = true`

- **"retry"** if:
  - Critical must-have fields are missing
  - AND retries remaining (current attempt < max_retries)
  - Set `is_complete = false`
  - Populate `retry_focus` with missing field names

- **"fail"** if:
  - Critical must-have fields are missing
  - AND all retries are exhausted
  - Set `is_complete = false`

- **"partial"** if:
  - Some must-have fields are present but not all
  - AND retries are exhausted
  - Set `is_complete = false`

---

## STEP 3: ENTITY DISCOVERY

**Only perform this step if `recommended_action` is "proceed" or "partial".**

If validation passes (or is partial), scan the content for new entities worth investigating.

### Discovery Criteria

Look for:
1. **Subsidiaries or Related Companies** - mentioned companies worth analyzing
2. **Key People/Roles** - executives or decision-makers relevant to goals
3. **Geographic Entities** - regional offices or markets worth separate analysis
4. **Product Lines or Business Units** - distinct segments warranting analysis

### Expansion Rules

{% set is_dynamically_created = current_node.parent_id is not none %}
{% set can_expand = not is_dynamically_created and current_node.depth < global_constraints.max_depth %}

**Expansion Status:** {% if can_expand %}Allowed{% else %}**DISABLED** ({% if is_dynamically_created %}this node was dynamically created and cannot spawn children{% else %}max depth reached{% endif %}){% endif %}

Set `should_expand = true` ONLY if **ALL** conditions are met:
- **Expansion is allowed** (see status above - if DISABLED, always set `should_expand = false`)
- The entity is **clearly identified** (not vague mentions)
- The entity is **relevant** to the analysis goals
- Analysis would provide **additional value**
- The entity is **not already** part of the analysis tree

{% if not can_expand %}
⚠️ **IMPORTANT**: Since expansion is DISABLED for this node, you MUST set `should_expand = false` and leave `discovered_entities` empty.
{% endif %}

For each discovered entity, include in `discovered_entities`:
- `name`: Clear entity name
- `description`: What to research about this entity
- `entity_type`: Type (subsidiary, person, region, product)
- `extraction_fields`: List of fields to extract (with name, description, priority, data_type)
  - **IMPORTANT**: `priority` must be either `"must_have"` or `"nice_to_have"` (no other values allowed)

---

## Output Summary

Provide your analysis in the structured output with:

1. **extracted_fields**: List of extracted values with citations
2. **missing_fields**: Fields that could not be found
3. **is_complete**: Boolean indicating if requirements are met
4. **recommended_action**: One of "proceed", "retry", "fail", "partial"
5. **retry_focus**: Fields to target if retrying
6. **discovered_entities**: New entities to investigate (if expanding)
7. **should_expand**: Whether to add discovered entities to queue
8. **chain_of_thought**: Your step-by-step reasoning for all three steps
